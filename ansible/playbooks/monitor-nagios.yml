---
- name: Simple Nagios monitoring with auto-restart
  hosts: localhost
  become: no

  tasks:
    - name: Add PetClinic check to Nagios
      blockinfile:
        path: "/home/pet-clinic/nagios/etc/objects/localhost.cfg"
        marker: "# {mark} PETCLINIC CHECK"
        block: |
          define service{
            use                     local-service
            host_name               localhost
            service_description     PetClinic App
            check_command           check_http!-H localhost -p 9090 -u /petclinic
            max_check_attempts      3
            check_interval          1
            retry_interval          1
            contact_groups          admins
            active_checks_enabled   1
            passive_checks_enabled  1
          }

    - name: Restart Nagios with HUP signal
      shell: |
        if [ -f /home/pet-clinic/nagios/var/nagios.pid ]; then
          kill -HUP $(cat /home/pet-clinic/nagios/var/nagios.pid)
          echo "Nagios reloaded with HUP signal"
        else
          echo "Nagios PID file not found - start Nagios manually"
        fi
      args:
        executable: /bin/bash
      register: restart_result

    - name: Check if website is up
      uri:
        url: "http://localhost:9090/petclinic"
        status_code: 200
      ignore_errors: yes
      register: result
      changed_when: false

    - name: Create Nagios command file if needed
      file:
        path: /home/pet-clinic/nagios/var/rw/nagios.cmd
        state: touch
        mode: "0666"

    - name: Send check result to Nagios
      shell: |
        TIMESTAMP=$(date +%s)
        {% if result.status == 200 %}
        echo "[$TIMESTAMP] PROCESS_SERVICE_CHECK_RESULT;localhost;PetClinic App;0;OK - HTTP 200" > /home/pet-clinic/nagios/var/rw/nagios.cmd
        {% else %}
        echo "[$TIMESTAMP] PROCESS_SERVICE_CHECK_RESULT;localhost;PetClinic App;2;CRITICAL - Error: {{ result.status | default('No response') }}" > /home/pet-clinic/nagios/var/rw/nagios.cmd
        {% endif %}
      args:
        executable: /bin/bash

    - name: Show final status
      debug:
        msg: |
          ✅ Nagios monitoring configured!
          
          Website status: {{ 'UP ✓' if result.status == 200 else 'DOWN ✗' }}
          Nagios restart: {{ 'Reloaded with HUP' if restart_result.stdout_lines[0] == 'Nagios reloaded with HUP signal' else 'Need manual start' }}
          
          Check Nagios GUI: http://{{ ansible_default_ipv4.address }}/nagios
          Look for service: 'PetClinic App'
