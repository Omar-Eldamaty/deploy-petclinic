---
- name: Install and Configure Nagios in HOME
  hosts: localhost
  become: yes
  vars:
    nagios_version: "4.4.14"
    nagios_plugins_version: "2.4.6"
    nagios_prefix: "/home/pet-clinic/nagios"
    nagios_user: "nagios"
    nagios_group: "nagcmd"
    nagios_admin_user: "nagiosadmin"
    nagios_admin_password: "123"

  tasks:
    # ==================== TASK 1: Directory Setup ====================
    - name: Ensure HOME directory exists
      file:
        path: "{{ nagios_prefix }}"
        state: directory
        mode: "0755"
        owner: pet-clinic
        group: pet-clinic

    # ==================== TASK 2: Install Dependencies ====================
    - name: Install dependencies
      apt:
        name:
          - autoconf
          - gcc
          - libc6
          - make
          - wget
          - unzip
          - apache2
          - php
          - libapache2-mod-php
          - libgd-dev
          - libssl-dev
          - php-gd
          - openssl
          - python3-passlib
        state: present
        update_cache: yes

    # ==================== TASK 3: User/Group Setup ====================
    - name: Create nagios system user
      user:
        name: "{{ nagios_user }}"
        system: yes
        shell: /bin/bash

    - name: Create nagcmd group
      group:
        name: "{{ nagios_group }}"
        state: present

    - name: Add users to nagcmd
      user:
        name: "{{ item }}"
        groups: "{{ nagios_group }}"
        append: yes
      loop:
        - "{{ nagios_user }}"
        - www-data

    # ==================== TASK 4: Download & Extract Nagios Core ====================
    - name: Download Nagios Core
      get_url:
        url: "https://assets.nagios.com/downloads/nagioscore/releases/nagios-{{ nagios_version }}.tar.gz"
        dest: "/tmp/nagios-{{ nagios_version }}.tar.gz"

    - name: Extract Nagios Core
      unarchive:
        src: "/tmp/nagios-{{ nagios_version }}.tar.gz"
        dest: /tmp
        remote_src: yes

    # ==================== TASK 5: Build & Install Nagios Core ====================
    - name: Configure Nagios (prefix = home)
      shell: |
        cd /tmp/nagios-{{ nagios_version }}
        ./configure --prefix={{ nagios_prefix }} --with-command-group={{ nagios_group }}
      args:
        creates: "/tmp/nagios-{{ nagios_version }}/Makefile"

    - name: Compile and install Nagios to HOME
      shell: |
        cd /tmp/nagios-{{ nagios_version }}
        make all
        make install
        make install-config
        make install-commandmode
        make install-webconf
      args:
        creates: "{{ nagios_prefix }}/bin/nagios"

    # ==================== TASK 6: Web Interface Authentication ====================
    - name: Create htpasswd admin user
      htpasswd:
        path: "{{ nagios_prefix }}/etc/htpasswd.users"
        name: "{{ nagios_admin_user }}"
        password: "{{ nagios_admin_password }}"
        create: yes

    # ==================== TASK 7: Download & Install Nagios Plugins ====================
    - name: Download Nagios Plugins
      get_url:
        url: "https://nagios-plugins.org/download/nagios-plugins-{{ nagios_plugins_version }}.tar.gz"
        dest: "/tmp/nagios-plugins-{{ nagios_plugins_version }}.tar.gz"

    - name: Extract Nagios Plugins
      unarchive:
        src: "/tmp/nagios-plugins-{{ nagios_plugins_version }}.tar.gz"
        dest: /tmp
        remote_src: yes

    - name: Configure Plugins (install into HOME)
      shell: |
        cd /tmp/nagios-plugins-{{ nagios_plugins_version }}
        ./configure --prefix={{ nagios_prefix }} --with-nagios-user={{ nagios_user }} --with-nagios-group={{ nagios_user }}
      args:
        creates: "/tmp/nagios-plugins-{{ nagios_plugins_version }}/Makefile"

    - name: Install Plugins
      shell: |
        cd /tmp/nagios-plugins-{{ nagios_plugins_version }}
        make
        make install
      args:
        creates: "{{ nagios_prefix }}/libexec/check_http"

    # ==================== TASK 8: Set Permissions for Monitoring Files ====================
    - name: Set permissions on Nagios configuration directories
      file:
        path: "{{ item }}"
        state: directory
        owner: "{{ nagios_user }}"
        group: "{{ nagios_group }}"
        mode: "0775"
        recurse: yes
      loop:
        - "{{ nagios_prefix }}/etc"
        - "{{ nagios_prefix }}/etc/objects"
        - "{{ nagios_prefix }}/var"
        - "{{ nagios_prefix }}/var/spool"
        - "{{ nagios_prefix }}/var/spool/checkresults"

    - name: Ensure rw directory exists for command pipe
      file:
        path: "{{ nagios_prefix }}/var/rw"
        state: directory
        owner: "{{ nagios_user }}"
        group: "{{ nagios_group }}"
        mode: "0775"

    - name: Set permissions on command file (external command pipe)
      file:
        path: "{{ nagios_prefix }}/var/rw/nagios.cmd"
        state: touch
        owner: "{{ nagios_user }}"
        group: "{{ nagios_group }}"
        mode: "0664"

    - name: Set executable permissions on plugins
      file:
        path: "{{ nagios_prefix }}/libexec"
        state: directory
        mode: "0755"
        recurse: yes
        owner: "{{ nagios_user }}"
        group: "{{ nagios_group }}"

    - name: Set permissions on Nagios binary
      file:
        path: "{{ nagios_prefix }}/bin/nagios"
        mode: "0755"
        owner: "{{ nagios_user }}"
        group: "{{ nagios_group }}"

    - name: Set permissions on support binaries
      file:
        path: "{{ nagios_prefix }}/bin"
        state: directory
        mode: "0755"
        recurse: yes
        owner: "{{ nagios_user }}"
        group: "{{ nagios_group }}"

    # ==================== TASK 9: Apache Configuration ====================
    - name: Enable Apache CGI & Rewrite
      apache2_module:
        name: "{{ item }}"
        state: present
      loop:
        - rewrite
        - cgi

    - name: Restart Apache
      systemd:
        name: apache2
        state: restarted
        enabled: yes

    # ==================== TASK 10: Display Information ====================
    - name: Display Nagios access information
      debug:
        msg:
          - "Nagios installed in HOME: {{ nagios_prefix }}"
          - "Nagios URL: http://{{ ansible_default_ipv4.address }}/nagios"
          - "Username: {{ nagios_admin_user }}"
          - "Password: {{ nagios_admin_password }}"
          - "Configuration directory: {{ nagios_prefix }}/etc"
          - "Plugins directory: {{ nagios_prefix }}/libexec"
          - "To add new hosts/services, edit: {{ nagios_prefix }}/etc/objects/"
          - "Permissions set for easy editing by pet-clinic user"
